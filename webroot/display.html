<!doctype html>
<html>
    <head>
        <script src="/socket.io/socket.io.js"></script>
        <script src="/libraries/three.js"></script>

        <style>
            body {
                margin: 0;
            }

            canvas {
                display: block;
            }

            #startButton {
                position: absolute;
                height: 100%;
                width: 100%;
                border: none;
                text-align: center;
                font-size: 8em;
                background-color: black;
                color: #ffde3b;
            }
        </style>
    </head>
    <body>
        <button type="button" id="startButton">
            Place your phone on a flat surface and click to begin...
        </button>

        <script>
            var orientation = { alpha: 0, beta: 0, gamma: 0 };
            var calibration = { alpha: 0, beta: 0, gamma: 0 };

            var socket = io();

            socket.on("orientation", (orientation) => {
                window.orientation = orientation;
            });

            socket.on("calibrate", () => {
                console.log("calibrated");
                window.calibration = window.orientation;
            });

            var scene = new THREE.Scene();

            var camera = new THREE.PerspectiveCamera(
                75,
                window.innerWidth / window.innerHeight,
                0.1,
                1000,
            );

            var renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            var pivotPoint = new THREE.Object3D();
            scene.add(pivotPoint);

            var gripTexture = new THREE.TextureLoader().load(
                "textures/grip.png",
            );
            gripTexture.magFilter = THREE.NearestFilter;
            var gripMaterial = new THREE.MeshBasicMaterial({
                map: gripTexture,
            });
            var gripHeight = 20;
            var gripGeometry = new THREE.CylinderGeometry(4, 4, gripHeight, 32);
            var grip = new THREE.Mesh(gripGeometry, gripMaterial);
            grip.position.set(0, gripHeight / 2, 0);
            pivotPoint.add(grip);

            var bladeTexture = new THREE.TextureLoader().load(
                "textures/blade.png",
            );
            var bladeMaterial = new THREE.MeshBasicMaterial({
                map: bladeTexture,
            });
            var bladeHeight = 100;
            var bladeGeometry = new THREE.CylinderGeometry(
                2,
                4,
                bladeHeight,
                32,
            );
            var blade = new THREE.Mesh(bladeGeometry, bladeMaterial);
            blade.position.set(0, gripHeight + bladeHeight / 2, 0);
            pivotPoint.add(blade);

            camera.position.z = 100;
            camera.position.y = 70;

            var listener = new THREE.AudioListener();
            camera.add(listener);

            var sound = new THREE.Audio(listener);
            var audioLoader = new THREE.AudioLoader();
            audioLoader.load("sounds/hum.ogg", function (buffer) {
                sound.setBuffer(buffer);
                sound.setLoop(true);
                sound.setVolume(0.5);
            });

            function animate() {
                requestAnimationFrame(animate);
                renderer.render(scene, camera);

                var alpha = degreesToRadians(
                    orientation.alpha - calibration.alpha,
                );
                var beta = degreesToRadians(
                    orientation.beta - calibration.beta,
                );
                var gamma = degreesToRadians(
                    orientation.gamma - calibration.gamma,
                );

                pivotPoint.rotation.x = beta;
                pivotPoint.rotation.z = -gamma;
            }

            function start() {
                animate();
                sound.play();
                document.getElementById("startButton").remove();
            }

            document
                .getElementById("startButton")
                .addEventListener("click", start);

            function degreesToRadians(angle) {
                return (angle / 180) * Math.PI;
            }
        </script>
    </body>
</html>
